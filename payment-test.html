<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>NMI Payment Test - CDN Version</title>

		<!-- Import map to resolve npm package via CDN -->
		<script type="importmap">
			{
				"imports": {
					"@nmipayments/nmi-pay": "https://cdn.skypack.dev/@nmipayments/nmi-pay"
				}
			}
		</script>

		<!-- Bootstrap CSS -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
			crossorigin="anonymous"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
			rel="stylesheet"
		/>

		<style>
			body {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				padding: 2rem 0;
			}
			.card {
				border-radius: 15px;
			}
			.card-header {
				border-radius: 15px 15px 0 0 !important;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-lg-8">
					<div class="card shadow-lg border-0">
						<div class="card-header bg-primary text-white text-center py-4">
							<h2 class="mb-0">
								<i class="fas fa-credit-card me-2"></i>
								NMI Payment Test (CDN)
							</h2>
							<p class="mb-0 mt-2 small">
								Testing @nmipayments/nmi-pay via Skypack CDN
							</p>
						</div>
						<div class="card-body p-4">
							<!-- Customer Information Form -->
							<form id="checkout-form">
								<!-- Personal Information -->
								<div class="mb-4">
									<h5 class="text-primary mb-3">
										<i class="fas fa-user me-2"></i>
										Personal Information
									</h5>
									<div class="row">
										<div class="col-md-6 mb-3">
											<label for="first_name" class="form-label"
												>First Name <span class="text-danger">*</span></label
											>
											<input
												type="text"
												class="form-control"
												id="first_name"
												name="first_name"
												value="John"
												required
											/>
										</div>
										<div class="col-md-6 mb-3">
											<label for="last_name" class="form-label"
												>Last Name <span class="text-danger">*</span></label
											>
											<input
												type="text"
												class="form-control"
												id="last_name"
												name="last_name"
												value="Doe"
												required
											/>
										</div>
									</div>
									<div class="row">
										<div class="col-md-6 mb-3">
											<label for="email" class="form-label"
												>Email Address <span class="text-danger">*</span></label
											>
											<input
												type="email"
												class="form-control"
												id="email"
												name="email"
												value="john.doe@example.com"
												required
											/>
										</div>
										<div class="col-md-6 mb-3">
											<label for="phone" class="form-label">Phone Number</label>
											<input
												type="tel"
												class="form-control"
												id="phone"
												name="phone"
												value="555-123-4567"
											/>
										</div>
									</div>
								</div>

								<!-- Billing Address -->
								<div class="mb-4">
									<h5 class="text-primary mb-3">
										<i class="fas fa-map-marker-alt me-2"></i>
										Billing Address
									</h5>
									<div class="mb-3">
										<label for="address1" class="form-label"
											>Address <span class="text-danger">*</span></label
										>
										<input
											type="text"
											class="form-control"
											id="address1"
											name="address1"
											value="123 Main St"
											required
										/>
									</div>
									<div class="row">
										<div class="col-md-4 mb-3">
											<label for="city" class="form-label"
												>City <span class="text-danger">*</span></label
											>
											<input
												type="text"
												class="form-control"
												id="city"
												name="city"
												value="New York"
												required
											/>
										</div>
										<div class="col-md-4 mb-3">
											<label for="state" class="form-label"
												>State <span class="text-danger">*</span></label
											>
											<input
												type="text"
												class="form-control"
												id="state"
												name="state"
												value="NY"
												maxlength="2"
												required
											/>
										</div>
										<div class="col-md-4 mb-3">
											<label for="zip" class="form-label"
												>ZIP Code <span class="text-danger">*</span></label
											>
											<input
												type="text"
												class="form-control"
												id="zip"
												name="zip"
												value="10001"
												required
											/>
										</div>
									</div>
								</div>

								<!-- Order Summary -->
								<div class="mb-4">
									<h5 class="text-primary mb-3">
										<i class="fas fa-shopping-cart me-2"></i>
										Order Amount
									</h5>
									<div class="bg-light p-3 rounded">
										<div class="input-group">
											<span class="input-group-text">$</span>
											<input
												type="number"
												class="form-control"
												id="amount"
												name="amount"
												step="0.01"
												min="0.01"
												value="10.99"
												required
											/>
											<span class="input-group-text">USD</span>
										</div>
									</div>
								</div>

								<!-- Payment Widget Container -->
								<div class="mb-4">
									<h5 class="text-primary mb-3">
										<i class="fas fa-credit-card me-2"></i>
										Payment Information
									</h5>
									<div
										id="payment-container"
										class="border rounded p-3 bg-light"
									>
										<div class="text-center text-muted">
											<div
												class="spinner-border spinner-border-sm me-2"
												role="status"
											>
												<span class="visually-hidden">Loading...</span>
											</div>
											Loading payment form...
										</div>
									</div>
								</div>

								<!-- Success/Error Messages -->
								<div id="payment-messages"></div>

								<!-- Processing Indicator -->
								<div id="processing-indicator" class="text-center d-none">
									<div class="spinner-border text-primary" role="status">
										<span class="visually-hidden">Processing...</span>
									</div>
									<p class="mt-2 text-muted">Processing your payment...</p>
								</div>

								<!-- Info Box -->
								<div class="alert alert-info mt-4">
									<i class="fas fa-info-circle me-2"></i>
									<strong>Test Mode:</strong> This is loading the NMI Payments
									component via CDN (Skypack). Check the browser console for
									detailed logs.
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Payment Component Script -->
		<script type="module">
			import { mountNmiPayments } from "@nmipayments/nmi-pay";

			console.log("üöÄ Starting NMI Payment Component Test via CDN");

			// Utility functions
			function showMessage(type, message) {
				const messagesContainer = document.getElementById("payment-messages");
				const alertClass =
					type === "success" ? "success" : type === "info" ? "info" : "danger";
				const icon =
					type === "success"
						? "check-circle"
						: type === "info"
						? "info-circle"
						: "exclamation-triangle";

				messagesContainer.innerHTML = `
          <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
			}

			function showProcessing(show) {
				const indicator = document.getElementById("processing-indicator");
				indicator.classList.toggle("d-none", !show);
			}

			function getFormData() {
				const form = document.getElementById("checkout-form");
				const formData = new FormData(form);
				const data = {};
				for (let [key, value] of formData.entries()) {
					data[key] = value;
				}
				return data;
			}

			// Initialize on DOM ready
			document.addEventListener("DOMContentLoaded", async function () {
				try {
					console.log("üì¶ Importing NMI Payments from CDN...");

					// Generate random amount
					const randomAmount = (Math.random() * 99 + 1).toFixed(2);
					document.getElementById("amount").value = randomAmount;

					let paymentToken = null;

					// Mount the payment widget
					console.log("üé® Mounting payment widget...");
					const widget = await mountNmiPayments("#payment-container", {
						// Using a public test tokenization key (replace with your own)
						//tokenizationKey: "z4ZWYx-QWAv8X-D8X4d5-5NZpD3",
						// Sandbox Key
						tokenizationKey: "Mm3Pt3-e6BCRA-329Frx-Ct5T9m",
						layout: "multiLine",
						paymentMethods: ["card", "google-pay", "apple-pay"],
						appearance: {
							theme: "light",
						},
						expressCheckoutConfig: {
							amount: 10.0,
							currency: "USD",
						},

						// Called when payment form state changes
						onChange: (data) => {
							console.log("üìù Payment form onChange:", data);

							if (data.complete && data.token) {
								paymentToken = data.token;
								console.log("‚úÖ Payment token received:", paymentToken);
								showMessage(
									"success",
									"Payment information validated! Token: " +
										paymentToken.substring(0, 20) +
										"..."
								);
							}
						},

						// Called when user submits payment
						onPay: async (token, paymentMethod, paymentData) => {
							console.log("üí≥ onPay triggered!");
							console.log("- Token:", token);
							console.log("- Payment Method:", paymentMethod);
							console.log("- Payment Data:", paymentData);

							paymentToken = token;

							try {
								showProcessing(true);
								showMessage("info", "Processing payment...");

								// Get form data
								const formData = getFormData();
								const amount = parseFloat(formData.amount);

								// Simulate payment processing
								console.log("üí∞ Payment Details:", {
									token: paymentToken,
									amount: amount,
									firstName: formData.first_name,
									lastName: formData.last_name,
									email: formData.email,
								});

								// In a real implementation, you would send this to your backend:
								// const response = await fetch('/api/process-payment', {
								//   method: 'POST',
								//   headers: { 'Content-Type': 'application/json' },
								//   body: JSON.stringify({
								//     paymentToken: token,
								//     amount: amount,
								//     ...formData
								//   })
								// });

								// Simulate API delay
								await new Promise((resolve) => setTimeout(resolve, 2000));

								// Simulate successful response
								const mockResponse = {
									success: true,
									transactionId: "TEST-" + Date.now(),
									amount: amount,
								};

								console.log("‚úÖ Payment successful:", mockResponse);
								showMessage(
									"success",
									`Payment successful! Transaction ID: ${mockResponse.transactionId}`
								);

								return true;
							} catch (error) {
								console.error("‚ùå Payment error:", error);
								showMessage("error", `Payment error: ${error.message}`);
								return error.message;
							} finally {
								showProcessing(false);
							}
						},

						// Called when payment fields are available
						onFieldsAvailable: () => {
							console.log("üéØ Payment fields are ready!");
							showMessage(
								"info",
								"Payment form loaded successfully! You can now enter payment details."
							);
						},
					});

					console.log("‚úÖ Payment widget mounted successfully!", widget);
				} catch (error) {
					console.error("‚ùå Error loading payment widget:", error);
					showMessage(
						"error",
						"Error loading payment widget: " + error.message
					);
				}
			});
		</script>

		<!-- Bootstrap JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	</body>
</html>
